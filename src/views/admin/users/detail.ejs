<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="description" content="Hotel Management System" />
    <meta name="author" content="HaNguyen051" />
    <title><%= title %> - HaNguyen051</title>
    <link href="/admin/css/styles.css" rel="stylesheet" />
    <script
      src="https://use.fontawesome.com/releases/v6.3.0/js/all.js"
      crossorigin="anonymous"
    ></script>
  </head>

  <body class="sb-nav-fixed">
    <%- include('../layout/header'); -%>

    <div id="layoutSidenav">
      <%- include('../layout/sidenav'); -%>
      <div id="layoutSidenav_content">
        <main>
          <div class="container-fluid px-4">
            <h1 class="mt-4"><%= title %></h1>
            <ol class="breadcrumb mb-4">
              <li class="breadcrumb-item"><a href="/admin">Dashboard</a></li>
              <li class="breadcrumb-item"><a href="/admin/users">Users</a></li>
              <li class="breadcrumb-item active">User #<%= user.id %></li>
            </ol>

            <div class="row">
              <!-- Thông tin user -->
              <div class="col-md-4">
                <div class="card mb-4">
                  <div class="card-header bg-primary text-white">
                    <h5><i class="fas fa-user"></i> Thông tin User</h5>
                  </div>
                  <div class="card-body">
                    <div class="text-center mb-3">
                      <div
                        class="avatar-circle mx-auto"
                        style="
                          width: 100px;
                          height: 100px;
                          background: linear-gradient(
                            135deg,
                            #667eea 0%,
                            #764ba2 100%
                          );
                          border-radius: 50%;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                        "
                      >
                        <span
                          style="
                            font-size: 40px;
                            color: white;
                            font-weight: bold;
                          "
                        >
                          <%= user.name.charAt(0).toUpperCase() %>
                        </span>
                      </div>
                    </div>

                    <table class="table table-borderless">
                      <tr>
                        <th width="35%">ID:</th>
                        <td><strong><%= user.id %></strong></td>
                      </tr>
                      <tr>
                        <th>Tên:</th>
                        <td><strong><%= user.name %></strong></td>
                      </tr>
                      <tr>
                        <th>Email:</th>
                        <td><%= user.email %></td>
                      </tr>
                      <tr>
                        <th>Phone:</th>
                        <td><%= user.phone || 'Chưa cập nhật' %></td>
                      </tr>
                      <tr>
                        <th>Role:</th>
                        <td>
                          <span
                            class="badge <%= user.role === 'ADMIN' ? 'bg-danger' : 'bg-primary' %> fs-6"
                          >
                            <%= user.role %>
                          </span>
                        </td>
                      </tr>
                      <tr>
                        <th>Ngày tạo:</th>
                        <td><%= user.createdAt.toLocaleString('vi-VN') %></td>
                      </tr>
                    </table>

                    <div class="d-flex gap-2 mt-3">
                      <a
                        href="/admin/handle-edit-user/<%= user.id %>"
                        class="btn btn-warning w-100"
                      >
                        <i class="fas fa-edit"></i> Sửa
                      </a>
                      <a href="/admin/users" class="btn btn-secondary w-100">
                        <i class="fas fa-arrow-left"></i> Quay lại
                      </a>
                    </div>
                  </div>
                </div>

                <!-- Thống kê -->
                <div class="card">
                  <div class="card-header bg-info text-white">
                    <h5><i class="fas fa-chart-bar"></i> Thống kê</h5>
                  </div>
                  <div class="card-body">
                    <div class="row text-center">
                      <div class="col-6 mb-3">
                        <div class="p-3 bg-light rounded">
                          <h3 class="text-primary mb-0">
                            <%= user.bookings.length %>
                          </h3>
                          <small class="text-muted">Bookings</small>
                        </div>
                      </div>
                      <div class="col-6 mb-3">
                        <div class="p-3 bg-light rounded">
                          <h3 class="text-success mb-0">
                            <%= user.payments.length %>
                          </h3>
                          <small class="text-muted">Payments</small>
                        </div>
                      </div>
                    </div>

                    <% let totalPaid = 0; user.payments.forEach(p => { if
                    (p.status === 'SUCCESS') { totalPaid += p.amount; } }); %>
                    <div class="alert alert-success mb-0">
                      <strong>Tổng chi tiêu:</strong><br />
                      <h4 class="mb-0">
                        <%= totalPaid.toLocaleString('vi-VN') %> VNĐ
                      </h4>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Lịch sử booking và payment -->
              <div class="col-md-8">
                <!-- Bookings -->
                <div class="card mb-3">
                  <div class="card-header bg-warning">
                    <h5>
                      <i class="fas fa-calendar-check"></i> Lịch sử Booking (<%=
                      user.bookings.length %>)
                    </h5>
                  </div>
                  <div class="card-body">
                    <% if (user.bookings.length === 0) { %>
                    <p class="text-muted mb-0">Chưa có booking nào</p>
                    <% } else { %>
                    <div class="table-responsive">
                      <table class="table table-hover">
                        <thead>
                          <tr>
                            <th>ID</th>
                            <th>Phòng</th>
                            <th>Check-in</th>
                            <th>Check-out</th>
                            <th>Số đêm</th>
                            <th>Tổng tiền</th>
                            <th>Status</th>
                            <th>Payment</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% user.bookings.forEach(function(booking) { const
                          days = Math.ceil((new Date(booking.dateTo) - new
                          Date(booking.dateFrom)) / (1000 * 60 * 60 * 24));
                          const totalCost = booking.room.cost * days; %>
                          <tr>
                            <td><strong>#<%= booking.id %></strong></td>
                            <td><%= booking.room.name %></td>
                            <td>
                              <%= new
                              Date(booking.dateFrom).toLocaleDateString('vi-VN')
                              %>
                            </td>
                            <td>
                              <%= new
                              Date(booking.dateTo).toLocaleDateString('vi-VN')
                              %>
                            </td>
                            <td><%= days %> đêm</td>
                            <td>
                              <strong
                                ><%= totalCost.toLocaleString('vi-VN')
                                %></strong
                              >
                            </td>
                            <td>
                              <% if (booking.status === 'CONFIRMED') { %>
                              <span class="badge bg-success">CONFIRMED</span>
                              <% } else if (booking.status === 'PENDING') { %>
                              <span class="badge bg-warning">PENDING</span>
                              <% } else { %>
                              <span class="badge bg-danger">CANCELLED</span>
                              <% } %>
                            </td>
                            <td>
                              <% if (booking.payment) { %>
                              <i
                                class="fas fa-check-circle text-success"
                                title="Đã thanh toán"
                              ></i>
                              <% } else { %>
                              <i
                                class="fas fa-times-circle text-danger"
                                title="Chưa thanh toán"
                              ></i>
                              <% } %>
                            </td>
                          </tr>
                          <% }) %>
                        </tbody>
                      </table>
                    </div>
                    <% } %>
                  </div>
                </div>

                <!-- Payments -->
                <div class="card">
                  <div class="card-header bg-success text-white">
                    <h5>
                      <i class="fas fa-money-bill-wave"></i> Lịch sử Payment
                      (<%= user.payments.length %>)
                    </h5>
                  </div>
                  <div class="card-body">
                    <% if (user.payments.length === 0) { %>
                    <p class="text-muted mb-0">Chưa có payment nào</p>
                    <% } else { %>
                    <div class="table-responsive">
                      <table class="table table-hover">
                        <thead>
                          <tr>
                            <th>ID</th>
                            <th>Booking</th>
                            <th>Số tiền</th>
                            <th>Phương thức</th>
                            <th>Status</th>
                            <th>Ngày thanh toán</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% user.payments.forEach(function(payment) { %>
                          <tr>
                            <td><strong>#<%= payment.id %></strong></td>
                            <td>
                              <a
                                href="/admin/handle-view-booking/<%= payment.bookingId %>"
                              >
                                Booking #<%= payment.bookingId %>
                              </a>
                            </td>
                            <td>
                              <strong
                                class="<%= payment.status === 'SUCCESS' ? 'text-success' : 'text-muted' %>"
                              >
                                <%= payment.amount.toLocaleString('vi-VN') %>
                                VNĐ
                              </strong>
                            </td>
                            <td>
                              <% if (payment.method === 'CASH') { %>
                              <i class="fas fa-money-bill text-success"></i>
                              CASH <% } else { %>
                              <i class="fas fa-qrcode text-primary"></i> QR <% }
                              %>
                            </td>
                            <td>
                              <% if (payment.status === 'SUCCESS') { %>
                              <span class="badge bg-success">SUCCESS</span>
                              <% } else if (payment.status === 'PENDING') { %>
                              <span class="badge bg-warning">PENDING</span>
                              <% } else { %>
                              <span class="badge bg-danger">FAILED</span>
                              <% } %>
                            </td>
                            <td>
                              <%= payment.createdAt.toLocaleString('vi-VN') %>
                            </td>
                          </tr>
                          <% }) %>
                        </tbody>
                      </table>
                    </div>
                    <% } %>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
        <%- include('../layout/footer'); -%>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>
    <script src="/admin/js/scripts.js"></script>
  </body>
</html>
