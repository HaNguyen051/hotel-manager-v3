<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Quản lý Thanh toán - Hotel Manager</title>
    <link href="/admin/css/styles.css" rel="stylesheet" />
    <script
      src="https://use.fontawesome.com/releases/v6.3.0/js/all.js"
      crossorigin="anonymous"
    ></script>
  </head>

  <body class="sb-nav-fixed">
    <%- include('../layout/header') %>

    <div id="layoutSidenav">
      <%- include('../layout/sidenav') %>
      <div id="layoutSidenav_content">
        <main>
          <div class="container-fluid px-4">
            <h1 class="mt-4">Quản lý thanh toán</h1>
            <ol class="breadcrumb mb-4">
              <li class="breadcrumb-item"><a href="/admin">Dashboard</a></li>
              <li class="breadcrumb-item active">Thanh toán</li>
            </ol>

            <% if (typeof success_msg !== 'undefined' && success_msg &&
            success_msg.length > 0) { %>
            <div
              class="alert alert-success alert-dismissible fade show"
              role="alert"
            >
              <%- success_msg[0] %>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="alert"
              ></button>
            </div>
            <% } %> <% if (typeof error_msg !== 'undefined' && error_msg &&
            error_msg.length > 0) { %>
            <div
              class="alert alert-danger alert-dismissible fade show"
              role="alert"
            >
              <%- error_msg[0] %>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="alert"
              ></button>
            </div>
            <% } %> <% if (typeof error !== 'undefined' && error) { %>
            <div class="alert alert-danger"><%= error %></div>
            <% } %>

            <div class="card mb-4 shadow-sm">
              <div class="card-body">
                <div class="btn-group w-100 flex-wrap" role="group">
                  <a
                    href="/admin/payment"
                    class="btn <%= filterStatus === 'all' ? 'btn-primary active' : 'btn-outline-primary' %> mb-1 me-1"
                    >Tất cả</a
                  >
                  <a
                    href="/admin/payment?status=PENDING"
                    class="btn <%= filterStatus === 'PENDING' ? 'btn-warning active text-dark' : 'btn-outline-warning' %> mb-1 me-1"
                    >Chờ thanh toán</a
                  >
                  <a
                    href="/admin/payment?status=SUCCESS"
                    class="btn <%= filterStatus === 'SUCCESS' ? 'btn-success active' : 'btn-outline-success' %> mb-1 me-1"
                    >Đã thanh toán</a
                  >
                  <a
                    href="/admin/payment?status=FAILED"
                    class="btn <%= filterStatus === 'FAILED' ? 'btn-danger active' : 'btn-outline-danger' %> mb-1 me-1"
                    >Thất bại</a
                  >
                  <a
                    href="/admin/payment?status=REFUNDED"
                    class="btn <%= filterStatus === 'REFUNDED' ? 'btn-secondary active' : 'btn-outline-secondary' %> mb-1"
                    >Đã hoàn tiền</a
                  >
                </div>
              </div>
            </div>

            <div class="card mb-4 shadow-sm">
              <div class="card-header">
                <i class="fas fa-credit-card me-1"></i>Danh sách thanh toán
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-hover table-bordered align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>ID</th>
                        <th>Booking</th>
                        <th>Khách hàng</th>
                        <th>Phòng</th>
                        <th class="text-end">Số tiền</th>
                        <th>Phương thức</th>
                        <th class="text-center">Trạng thái</th>
                        <th>Ngày thanh toán</th>
                        <th>Thao tác</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% if (payments && payments.length > 0) { %> <%
                      payments.forEach(function(p) { %>
                      <tr>
                        <td>#<%= p.id %></td>
                        <td>
                          <% if (p.booking) { %>
                          <a href="/admin/booking/detail/<%= p.bookingId %>"
                            >#<%= p.bookingId %></a
                          >
                          <% } else { %>
                          <span class="text-muted">#<%= p.bookingId %></span>
                          <% } %>
                        </td>
                        <td>
                          <% if (p.booking && p.booking.user) { %> <%=
                          p.booking.user.fullName || p.booking.user.username
                          %><br />
                          <small class="text-muted"
                            ><%= p.booking.user.phone || 'N/A' %></small
                          >
                          <% } else if (p.booking) { %> <%= p.booking.guestName
                          %><br />
                          <small class="text-muted"
                            ><%= p.booking.guestPhone %></small
                          >
                          <% } else { %>
                          <span class="text-muted">N/A</span>
                          <% } %>
                        </td>
                        <td>
                          <% if (p.booking && p.booking.roomBookings &&
                          p.booking.roomBookings[0] &&
                          p.booking.roomBookings[0].room) { %> <%=
                          p.booking.roomBookings[0].room.name %>
                          <small class="d-block text-muted"
                            >(<%= p.booking.roomBookings[0].room.type %>)</small
                          >
                          <% } else { %>
                          <span class="text-muted">N/A</span>
                          <% } %>
                        </td>
                        <td class="text-end">
                          <strong
                            ><%= p.totalAmount.toLocaleString('vi-VN')
                            %>đ</strong
                          >
                        </td>
                        <td>
                          <% if (p.paymentMethod === 'CASH') { %>
                          <span class="badge bg-success p-2">Tiền mặt</span>
                          <% } else if (p.paymentMethod === 'CARD') { %>
                          <span class="badge bg-primary p-2">Thẻ</span>
                          <% } else if (p.paymentMethod === 'BANK_TRANSFER') {
                          %>
                          <span class="badge bg-info text-dark p-2"
                            >Chuyển khoản</span
                          >
                          <% } else if (p.paymentMethod === 'MOBILE_PAYMENT') {
                          %>
                          <span class="badge bg-warning text-dark p-2"
                            >Ví điện tử</span
                          >
                          <% } else { %>
                          <span class="badge bg-secondary p-2"
                            ><%= p.paymentMethod %></span
                          >
                          <% } %>
                        </td>
                        <td class="text-center">
                          <% if (p.paymentStatus === 'PENDING') { %>
                          <span class="badge bg-warning text-dark p-2"
                            >Chờ thanh toán</span
                          >
                          <% } else if (p.paymentStatus === 'SUCCESS') { %>
                          <span class="badge bg-success p-2"
                            >Đã thanh toán</span
                          >
                          <% } else if (p.paymentStatus === 'FAILED') { %>
                          <span class="badge bg-danger p-2">Thất bại</span>
                          <% } else if (p.paymentStatus === 'REFUNDED') { %>
                          <span class="badge bg-secondary p-2"
                            >Đã hoàn tiền</span
                          >
                          <% } else { %>
                          <span class="badge bg-secondary p-2"
                            ><%= p.paymentStatus %></span
                          >
                          <% } %>
                        </td>
                        <td>
                          <% if (p.paidAt) { %> <%= new
                          Date(p.paidAt).toLocaleString('vi-VN') %> <% } else {
                          %> Chưa thanh toán <% } %>
                        </td>
                        <td>
                          <div class="btn-group btn-group-sm">
                            <a
                              href="/admin/view-payment/<%= p.id %>"
                              class="btn btn-info"
                            >
                              <i class="fas fa-eye"></i>
                            </a>
                            <% if (p.paymentStatus === 'PENDING' ||
                            p.paymentStatus === 'FAILED') { %>
                            <form
                              action="/admin/payment/delete/<%= p.id %>"
                              method="POST"
                              class="d-inline"
                              onsubmit="return confirm('Xóa payment này?')"
                            >
                              <button type="submit" class="btn btn-danger">
                                <i class="fas fa-trash-alt"></i>
                              </button>
                            </form>
                            <% } %>
                          </div>
                        </td>
                      </tr>
                      <% }) %> <% } else { %>
                      <tr>
                        <td colspan="9" class="text-center text-muted py-3">
                          Không có dữ liệu thanh toán
                        </td>
                      </tr>
                      <% } %>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </main>
        <%- include('../layout/footer') %>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/admin/js/scripts.js"></script>
  </body>
</html>
