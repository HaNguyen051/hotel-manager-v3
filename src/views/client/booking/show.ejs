<!-- ==================== views/client/booking/show.ejs ==================== -->
<%- include('../layout/header'); -%>

<!-- Page Header Start -->
<div
  class="container-fluid page-header mb-5 p-0"
  style="background-image: url(/client/img/carousel-1.jpg)"
>
  <div class="container-fluid page-header-inner py-5">
    <div class="container text-center pb-5">
      <h1 class="display-3 text-white mb-3 animated slideInDown">Đặt Phòng</h1>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb justify-content-center text-uppercase">
          <li class="breadcrumb-item"><a href="/">Home</a></li>
          <li class="breadcrumb-item"><a href="/">Pages</a></li>
          <li class="breadcrumb-item text-white active" aria-current="page">
            Booking
          </li>
        </ol>
      </nav>
    </div>
  </div>
</div>
<!-- Page Header End -->

<!-- Booking Start -->
<div class="container-xxl py-5" style="margin-bottom: 200px">
  <div class="container">
    <div class="text-center wow fadeInUp" data-wow-delay="0.1s">
      <h6 class="section-title text-center text-primary text-uppercase">
        Đặt Phòng
      </h6>
      <h1 class="mb-5">
        Đặt Phòng <span class="text-primary text-uppercase">Sang Trọng</span>
      </h1>
    </div>

    <div class="row g-5">
      <!-- Left: Images -->
      <div class="col-lg-6">
        <div class="row g-3">
          <div class="col-6 text-end">
            <img
              class="img-fluid rounded w-75 wow zoomIn"
              data-wow-delay="0.1s"
              src="/client/img/about-1.jpg"
              style="margin-top: 25%"
            />
          </div>
          <div class="col-6 text-start">
            <img
              class="img-fluid rounded w-100 wow zoomIn"
              data-wow-delay="0.3s"
              src="/client/img/about-2.jpg"
            />
          </div>
          <div class="col-6 text-end">
            <img
              class="img-fluid rounded w-50 wow zoomIn"
              data-wow-delay="0.5s"
              src="/client/img/about-3.jpg"
            />
          </div>
          <div class="col-6 text-start">
            <img
              class="img-fluid rounded w-75 wow zoomIn"
              data-wow-delay="0.7s"
              src="/client/img/about-4.jpg"
            />
          </div>
        </div>
      </div>

      <!-- Right: Form -->
      <div class="col-lg-6">
        <div class="wow fadeInUp" data-wow-delay="0.2s">
          <!-- Messages -->
          <% if (messages && messages.length > 0) { %> <%
          messages.forEach(function(msg) { %>
          <div
            class="alert alert-info alert-dismissible fade show"
            role="alert"
          >
            <%= msg %>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="alert"
            ></button>
          </div>
          <% }); %> <% } %> <% if (error) { %>
          <div
            class="alert alert-danger alert-dismissible fade show"
            role="alert"
          >
            <%= error %>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="alert"
            ></button>
          </div>
          <% } %>

          <form action="/booking/submit" method="post">
            <div class="row g-3">
              <!-- Tên khách -->
              <div class="col-md-6">
                <div class="form-floating">
                  <input
                    type="text"
                    class="form-control"
                    id="name"
                    name="guestName"
                    placeholder="Tên của bạn"
                    required
                  />
                  <label for="name">Tên khách *</label>
                </div>
              </div>

              <!-- Điện thoại -->
              <div class="col-md-6">
                <div class="form-floating">
                  <input
                    type="tel"
                    class="form-control"
                    id="phone"
                    name="guestPhone"
                    placeholder="Điện thoại"
                    required
                  />
                  <label for="phone">Điện thoại *</label>
                </div>
              </div>

              <!-- Email -->
              <div class="col-md-6">
                <div class="form-floating">
                  <input
                    type="email"
                    class="form-control"
                    id="email"
                    name="guestEmail"
                    placeholder="Email"
                  />
                  <label for="email">Email</label>
                </div>
              </div>

              <!-- Số người -->
              <div class="col-md-6">
                <div class="form-floating">
                  <select
                    class="form-select"
                    id="guestCount"
                    name="guestCount"
                    required
                  >
                    <option value="">-- Chọn số người --</option>
                    <option value="1">1 Người</option>
                    <option value="2">2 Người</option>
                    <option value="3">3 Người</option>
                    <option value="4">4 Người</option>
                    <option value="5">5 Người</option>
                    <option value="6">6 Người</option>
                  </select>
                  <label for="guestCount">Số người *</label>
                </div>
              </div>

              <!-- Ngày nhận phòng -->
              <div class="col-md-6">
                <div
                  class="form-floating date"
                  id="date3"
                  data-target-input="nearest"
                >
                  <input
                    type="text"
                    class="form-control datetimepicker-input"
                    id="checkin"
                    name="checkInDate"
                    placeholder="Ngày nhận phòng"
                    data-target="#date3"
                    data-toggle="datetimepicker"
                    required
                  />
                  <label for="checkin">Ngày nhận phòng *</label>
                </div>
              </div>

              <!-- Ngày trả phòng -->
              <div class="col-md-6">
                <div
                  class="form-floating date"
                  id="date4"
                  data-target-input="nearest"
                >
                  <input
                    type="text"
                    class="form-control datetimepicker-input"
                    id="checkout"
                    name="checkOutDate"
                    placeholder="Ngày trả phòng"
                    data-target="#date4"
                    data-toggle="datetimepicker"
                    required
                  />
                  <label for="checkout">Ngày trả phòng *</label>
                </div>
              </div>

              <!-- Loại phòng -->
              <div class="col-12">
                <div class="form-floating">
                  <select
                    class="form-select"
                    id="roomType"
                    name="roomType"
                    required
                    onchange="updateAvailableRooms()"
                  >
                    <option value="">-- Chọn loại phòng --</option>
                    <% if (roomTypes && roomTypes.length > 0) { %> <%
                    roomTypes.forEach(function(type) { %>
                    <option value="<%= type %>"><%= type %></option>
                    <% }); %> <% } %>
                  </select>
                  <label for="roomType">Loại phòng *</label>
                </div>
              </div>

              <!-- Phòng cụ thể -->
              <div class="col-12">
                <div class="form-floating">
                  <select
                    class="form-select"
                    id="roomSelect"
                    name="roomId"
                    required
                  >
                    <option value="">-- Chọn phòng --</option>
                  </select>
                  <label for="roomSelect">Phòng *</label>
                </div>
              </div>

              <!-- Thông tin giá -->
              <div class="col-12">
                <div class="alert alert-info">
                  <div class="row">
                    <div class="col-6">
                      <strong>Giá/đêm:</strong>
                      <span id="pricePerNight">-</span>đ
                    </div>
                    <div class="col-6">
                      <strong>Số đêm:</strong> <span id="nights">-</span>
                    </div>
                  </div>
                  <hr />
                  <div>
                    <strong>Tổng cộng:</strong>
                    <span id="totalPrice" style="font-size: 18px; color: red"
                      >-</span
                    >đ
                  </div>
                </div>
              </div>

              <!-- Yêu cầu đặc biệt -->
              <div class="col-12">
                <div class="form-floating">
                  <textarea
                    class="form-control"
                    name="specialRequest"
                    id="message"
                    placeholder="Yêu cầu đặc biệt"
                    style="height: 100px"
                  ></textarea>
                  <label for="message">Yêu cầu đặc biệt</label>
                </div>
              </div>

              <!-- Button -->
              <div class="col-12">
                <button
                  class="btn btn-primary w-100 py-3"
                  type="submit"
                  id="submitBtn"
                >
                  Xác Nhận Đặt Phòng
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Booking End -->

<%- include('../layout/footer'); -%>

<script>
  // Lấy rooms theo loại phòng
  async function updateAvailableRooms() {
    const roomType = document.getElementById("roomType").value;
    const checkInDate = document.getElementById("checkin").value;
    const checkOutDate = document.getElementById("checkout").value;

    if (!roomType || !checkInDate || !checkOutDate) {
      alert("Vui lòng chọn loại phòng và ngày!");
      return;
    }

    try {
      const response = await fetch("/booking/available-rooms", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ roomType, checkInDate, checkOutDate }),
      });

      const data = await response.json();

      if (data.success) {
        const roomSelect = document.getElementById("roomSelect");
        roomSelect.innerHTML = '<option value="">-- Chọn phòng --</option>';

        if (data.rooms.length === 0) {
          roomSelect.innerHTML +=
            "<option disabled>Không còn phòng loại này</option>";
          updateTotalPrice();
          return;
        }

        data.rooms.forEach((room) => {
          const option = document.createElement("option");
          option.value = room.id;
          option.textContent = `${room.name} - ${room.price.toLocaleString(
            "vi-VN"
          )}đ/đêm`;
          option.dataset.price = room.price;
          roomSelect.appendChild(option);
        });

        roomSelect.onchange = updateTotalPrice;
      } else {
        alert(data.message || "Có lỗi xảy ra");
      }
    } catch (error) {
      console.error("Error:", error);
      alert("Lỗi kết nối server");
    }
  }

  // Tính tổng giá
  function updateTotalPrice() {
    const checkInDate = new Date(document.getElementById("checkin").value);
    const checkOutDate = new Date(document.getElementById("checkout").value);
    const roomSelect = document.getElementById("roomSelect");
    const selectedOption = roomSelect.options[roomSelect.selectedIndex];

    if (!selectedOption.value) {
      document.getElementById("pricePerNight").textContent = "-";
      document.getElementById("nights").textContent = "-";
      document.getElementById("totalPrice").textContent = "-";
      return;
    }

    const price = parseInt(selectedOption.dataset.price);
    const nights = Math.ceil(
      (checkOutDate - checkInDate) / (1000 * 60 * 60 * 24)
    );
    const total = price * nights;

    document.getElementById("pricePerNight").textContent =
      price.toLocaleString("vi-VN");
    document.getElementById("nights").textContent = nights;
    document.getElementById("totalPrice").textContent =
      total.toLocaleString("vi-VN");
  }

  // Event listeners
  document
    .getElementById("checkin")
    .addEventListener("change", updateTotalPrice);
  document
    .getElementById("checkout")
    .addEventListener("change", updateTotalPrice);
</script>
